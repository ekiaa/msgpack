%%%---------------------------------------------------------------------------------------------------------------------------------------------
%%% File        : msgpack_send.erl
%%% Author      : Ekimov Artem <ekimov-artem@ya.ru>
%%% Description : Message-pack send api and callback functions
%%% Created     : 25.04.2012
%%%---------------------------------------------------------------------------------------------------------------------------------------------

-module(msgpack_send).

-author('ekimov-artem@ya.ru').

-behaviour(gen_server).

-include("msgpack.hrl").

%% API functions

-export([start/2, start_link/2, stop/1]).

%% gen_server callbacks

-export([init/1, handle_call/3, handle_cast/2, handle_info/2, terminate/2, code_change/3]).

-record(state, {stream, socket}).

%%==============================================================================================================================================
%% API functions
%%==============================================================================================================================================

start(Stream, Socket) ->
	start_link(Stream, Socket).
	
start_link(Stream, Socket) ->
	gen_server:start_link(?MODULE, {Stream, Socket}, []).
	
stop(Pid) ->
	gen_server:call(Pid, stop).

%%==============================================================================================================================================
%% gen_server callbacks
%%==============================================================================================================================================

%%----------------------------------------------------------------------------------------------------------------------------------------------
%% Description : Initiates the decode manager
%%----------------------------------------------------------------------------------------------------------------------------------------------

init({Stream, Socket}) ->
	erlang:monitor(process, Stream),
 	{ok, #state{stream = Stream, socket = Socket}}.

%%----------------------------------------------------------------------------------------------------------------------------------------------
%% Description : Handling call messages
%%----------------------------------------------------------------------------------------------------------------------------------------------

handle_call(stop, _From, State) ->
	{stop, normal, ok, State};

handle_call(Request, From, State) ->
	{stop, {error, {?MODULE, handle_call, Request, From}}, State}.

%%----------------------------------------------------------------------------------------------------------------------------------------------
%% Description : Handling cast messages
%%----------------------------------------------------------------------------------------------------------------------------------------------

handle_cast({send, Msg}, S) ->
	Data = msgpack:encode(Msg),
%	?LOG(?MODULE, self(), "send msg: ~p", [Msg]),
	case gen_tcp:send(S#state.socket, Data) of
		ok ->
			{noreply, S};
		{error, Reason} ->
			{stop, {error, Reason}, S}
	end;
	
handle_cast(Msg, State) ->
	{stop, {error, {?MODULE, handle_cast, Msg}}, State}.

%%----------------------------------------------------------------------------------------------------------------------------------------------
%% Description : Handling all non call/cast messages
%%----------------------------------------------------------------------------------------------------------------------------------------------

handle_info({'DOWN', _MonRef, process, _Pid, _Info}, S) ->
	{stop, normal, S};
	
handle_info(Info, State) ->
	{stop, {error, {?MODULE, handle_info, Info}}, State}.

%%----------------------------------------------------------------------------------------------------------------------------------------------
%% Description : This function is called by a gen_server when it is about to terminate
%%----------------------------------------------------------------------------------------------------------------------------------------------

terminate(_Reason, _State) ->
	ok.

%%----------------------------------------------------------------------------------------------------------------------------------------------
%% Description : Convert process state when code is changed
%%----------------------------------------------------------------------------------------------------------------------------------------------

code_change(_OldVsn, State, _Extra) ->
	{ok, State}.

%%==============================================================================================================================================
%% Internal functions
%%==============================================================================================================================================

%%%---------------------------------------------------------------------------------------------------------------------------------------------
%%% End of file : msgpack_send.erl
%%%---------------------------------------------------------------------------------------------------------------------------------------------